#!/bin/bash
#
# Witness - Pre-commit Hook
#
# Runs quick quality checks before allowing a commit.
# Install: cp scripts/pre-commit .git/hooks/pre-commit && chmod +x .git/hooks/pre-commit
#

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# If running from .git/hooks, find project root
if [[ "$SCRIPT_DIR" == *".git/hooks"* ]]; then
    PROJECT_ROOT="$(dirname "$(dirname "$SCRIPT_DIR")")"
else
    PROJECT_ROOT="$(dirname "$SCRIPT_DIR")"
fi

cd "$PROJECT_ROOT"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

echo -e "${YELLOW}Running pre-commit checks...${NC}"

FAILED=0

# Get list of staged files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)

# Check if any Kotlin files are staged
if echo "$STAGED_FILES" | grep -q "\.kt$"; then
    echo "Checking Kotlin files..."
    if [ -d "android" ]; then
        cd android
        if ! ./gradlew compileDebugKotlin --quiet 2>/dev/null; then
            echo -e "${RED}Kotlin compilation failed${NC}"
            FAILED=1
        fi
        if ! ./gradlew ktlintCheck --quiet 2>/dev/null; then
            echo -e "${RED}ktlint check failed${NC}"
            echo "Run: cd android && ./gradlew ktlintFormat"
            FAILED=1
        fi
        cd "$PROJECT_ROOT"
    fi
fi

# Check if any Go files are staged
if echo "$STAGED_FILES" | grep -q "\.go$"; then
    echo "Checking Go files..."
    if [ -d "backend" ]; then
        cd backend
        if ! go build ./... 2>/dev/null; then
            echo -e "${RED}Go build failed${NC}"
            FAILED=1
        fi
        if ! go vet ./... 2>/dev/null; then
            echo -e "${RED}go vet failed${NC}"
            FAILED=1
        fi
        cd "$PROJECT_ROOT"
    fi
fi

# Block commits with secrets
if echo "$STAGED_FILES" | grep -qE "(\.env|credentials|secrets|\.keystore|\.jks|google-services\.json)"; then
    echo -e "${RED}Potential secrets detected in staged files!${NC}"
    echo "Review staged files and remove sensitive data."
    FAILED=1
fi

if [ $FAILED -eq 0 ]; then
    echo -e "${GREEN}Pre-commit checks passed!${NC}"
    exit 0
else
    echo -e "${RED}Pre-commit checks failed. Fix issues before committing.${NC}"
    exit 1
fi
